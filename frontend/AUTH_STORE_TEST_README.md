# ğŸ› auth-store Bugæ‰«æå™¨æµ‹è¯•å¥—ä»¶

## ğŸ“‹ æ¦‚è¿°

è¿™æ˜¯ä¸€ä¸ª**ä¸¥æ ¼çš„"Bugæ‰«æå™¨"æµ‹è¯•å¥—ä»¶**ï¼Œä¸º `auth-store.ts` æä¾›äº†å…¨é¢çš„è‡ªåŠ¨åŒ–æµ‹è¯•è¦†ç›–ã€‚

**æµ‹è¯•æ¡†æ¶ï¼š** Vitest + React Testing Library  
**æµ‹è¯•æ–‡ä»¶ï¼š** `frontend/src/stores/auth-store.test.ts`  
**æµ‹è¯•ç”¨ä¾‹æ€»æ•°ï¼š** **60+ ä¸ªæµ‹è¯•ç”¨ä¾‹**

---

## ğŸ¯ æµ‹è¯•è¦†ç›–èŒƒå›´

### âœ… 1. æ­£å¸¸è·¯å¾„æµ‹è¯•ï¼ˆ8ä¸ªç”¨ä¾‹ï¼‰
- âœ… è®¾ç½®ç”¨æˆ·ä¿¡æ¯
- âœ… è®¾ç½®è®¿é—®ä»¤ç‰Œ
- âœ… æ¸…é™¤è®¿é—®ä»¤ç‰Œ
- âœ… æ‰§è¡Œç™»å‡ºæ“ä½œ
- âœ… çŠ¶æ€æŒä¹…åŒ–åˆ° localStorage
- âœ… ä» localStorage æ¢å¤çŠ¶æ€
- âœ… å®Œæ•´ç™»å½•æµç¨‹æ¨¡æ‹Ÿ
- âœ… é¡µé¢åˆ·æ–°åçŠ¶æ€æ¢å¤

### âœ… 2. è¾¹ç•Œæƒ…å†µæµ‹è¯•ï¼ˆ12ä¸ªç”¨ä¾‹ï¼‰
- âœ… null/undefined ç”¨æˆ·å¤„ç†
- âœ… ç©ºå­—ç¬¦ä¸² token
- âœ… è¶…é•¿ tokenï¼ˆ10KB+ï¼‰
- âœ… ç”¨æˆ·å¯¹è±¡ç¼ºå°‘å¯é€‰å­—æ®µ
- âœ… ç”¨æˆ·å¯¹è±¡åŒ…å«é¢å¤–å­—æ®µ
- âœ… membershipExpireAt ä¸º null
- âœ… ç©ºå­—ç¬¦ä¸² email
- âœ… ç‰¹æ®Šå­—ç¬¦ emailï¼ˆ+ã€.ã€_ç­‰ï¼‰
- âœ… SSR ç¯å¢ƒï¼ˆwindow æœªå®šä¹‰ï¼‰
- âœ… æœ€å°åŒ–ç”¨æˆ·å¯¹è±¡
- âœ… å„ç§è¾¹ç•Œå€¼ç»„åˆ

### âœ… 3. å¼‚å¸¸è·¯å¾„æµ‹è¯•ï¼ˆ8ä¸ªç”¨ä¾‹ï¼‰
- âœ… localStorage.setItem æŠ›å‡º QuotaExceededError
- âœ… localStorage.setItem æŠ›å‡º SecurityErrorï¼ˆéšç§æ¨¡å¼ï¼‰
- âœ… localStorage.removeItem æŠ›å‡ºå¼‚å¸¸
- âœ… localStorage.getItem è¿”å›æ— æ•ˆ JSON
- âœ… localStorage.getItem è¿”å› null
- âœ… localStorage å®Œå…¨ä¸å¯ç”¨
- âœ… æŒä¹…åŒ–ä¸­é—´ä»¶å¤±è´¥åçš„çŠ¶æ€æ¢å¤
- âœ… å­˜å‚¨æ“ä½œå¼‚å¸¸å¤„ç†

### âœ… 4. æ½œåœ¨Bugæµ‹è¯•ï¼ˆ15ä¸ªç”¨ä¾‹ï¼‰
- âœ… çŠ¶æ€ä¸ä¸€è‡´é˜²æŠ¤ï¼ˆç”¨æˆ·å­˜åœ¨ä½†tokenä¸ºç©ºï¼‰
- âœ… tokenå­˜åœ¨ä½†ç”¨æˆ·ä¸ºç©ºï¼ˆå¼‚å¸¸çŠ¶æ€ï¼‰
- âœ… å¹¶å‘è®¾ç½®æ“ä½œï¼ˆå¤šä¸ªç»„ä»¶åŒæ—¶æ›´æ–°ï¼‰
- âœ… ç™»å‡ºåç«‹å³è®¾ç½®æ–°ç”¨æˆ·
- âœ… ç”¨æˆ·å¯¹è±¡è¢«ä¿®æ”¹åè®¾ç½®ï¼ˆå¼•ç”¨é—®é¢˜ï¼‰
- âœ… å¤§é‡å¿«é€ŸçŠ¶æ€æ›´æ–°ï¼ˆæ€§èƒ½æµ‹è¯•ï¼‰
- âœ… æŒä¹…åŒ–æ•°æ®æŸåï¼ˆç±»å‹ä¸åŒ¹é…ï¼‰
- âœ… æŒä¹…åŒ–æ•°æ®ç‰ˆæœ¬ä¸åŒ¹é…
- âœ… å¾ªç¯å¼•ç”¨å¯¹è±¡å¤„ç†
- âœ… å­˜å‚¨ç©ºé—´ä¸è¶³æ—¶çš„é™çº§ç­–ç•¥
- âœ… localStorage è¢«å…¶ä»–è„šæœ¬æ¸…ç©º
- âœ… æ¶æ„æ„é€ çš„ localStorage æ•°æ®ï¼ˆXSSæ”»å‡»é˜²æŠ¤ï¼‰
- âœ… å¤šæ ‡ç­¾é¡µçŠ¶æ€åŒæ­¥
- âœ… å„ç§å¼‚å¸¸æ•°æ®æ ¼å¼

### âœ… 5. é›†æˆæµ‹è¯•ï¼ˆ3ä¸ªç”¨ä¾‹ï¼‰
- âœ… å®Œæ•´ç”¨æˆ·ç™»å½•æµç¨‹
- âœ… é¡µé¢åˆ·æ–°åçš„çŠ¶æ€æ¢å¤
- âœ… å¤šæ ‡ç­¾é¡µçŠ¶æ€åŒæ­¥

---

## ğŸš€ å¦‚ä½•è¿è¡Œæµ‹è¯•

### å‰ç½®æ¡ä»¶

ç¡®ä¿å·²å®‰è£…æ‰€æœ‰ä¾èµ–ï¼š

```bash
cd frontend
npm install
```

### è¿è¡Œæµ‹è¯•

#### æ–¹å¼ 1ï¼šè¿è¡Œæ‰€æœ‰æµ‹è¯•ï¼ˆæ¨èï¼‰

```bash
npm test
```

è¿™ä¼šå¯åŠ¨ Vitest çš„äº¤äº’æ¨¡å¼ï¼Œä½ å¯ä»¥ï¼š
- æŒ‰ `a` è¿è¡Œæ‰€æœ‰æµ‹è¯•
- æŒ‰ `f` åªè¿è¡Œå¤±è´¥çš„æµ‹è¯•
- æŒ‰ `u` æ›´æ–°å¿«ç…§
- æŒ‰ `q` é€€å‡º

#### æ–¹å¼ 2ï¼šè¿è¡Œä¸€æ¬¡æµ‹è¯•ï¼ˆCI/CD ä½¿ç”¨ï¼‰

```bash
npm run test:run
```

#### æ–¹å¼ 3ï¼šè¿è¡Œæµ‹è¯•å¹¶ç”Ÿæˆè¦†ç›–ç‡æŠ¥å‘Š

```bash
npm run test:coverage
```

è¦†ç›–ç‡æŠ¥å‘Šä¼šç”Ÿæˆåœ¨ `coverage/` ç›®å½•ä¸­ã€‚

#### æ–¹å¼ 4ï¼šä½¿ç”¨å¯è§†åŒ– UI

```bash
npm run test:ui
```

è¿™ä¼šæ‰“å¼€ä¸€ä¸ªæµè§ˆå™¨ç•Œé¢ï¼Œå¯ä»¥å¯è§†åŒ–åœ°è¿è¡Œå’Œè°ƒè¯•æµ‹è¯•ã€‚

#### æ–¹å¼ 5ï¼šåªè¿è¡Œ auth-store æµ‹è¯•

```bash
npm test auth-store
```

---

## ğŸ“Š æµ‹è¯•ç»“æœç¤ºä¾‹

### æˆåŠŸè¿è¡Œç¤ºä¾‹

```
âœ“ auth-store.test.ts (60) 600ms
  âœ“ 1. æ­£å¸¸è·¯å¾„æµ‹è¯• (8)
    âœ“ åº”è¯¥æ­£ç¡®è®¾ç½®ç”¨æˆ·ä¿¡æ¯
    âœ“ åº”è¯¥æ­£ç¡®è®¾ç½®è®¿é—®ä»¤ç‰Œ
    âœ“ åº”è¯¥æ­£ç¡®æ¸…é™¤è®¿é—®ä»¤ç‰Œï¼ˆè®¾ç½®ä¸ºnullï¼‰
    âœ“ åº”è¯¥æ­£ç¡®æ‰§è¡Œç™»å‡ºæ“ä½œ
    âœ“ åº”è¯¥æŒä¹…åŒ–çŠ¶æ€åˆ° localStorage
    âœ“ åº”è¯¥ä» localStorage æ¢å¤çŠ¶æ€
    âœ“ åº”è¯¥å®Œæ•´æ¨¡æ‹Ÿç”¨æˆ·ç™»å½•æµç¨‹
    âœ“ åº”è¯¥å®Œæ•´æ¨¡æ‹Ÿé¡µé¢åˆ·æ–°åçš„çŠ¶æ€æ¢å¤
  âœ“ 2. è¾¹ç•Œæƒ…å†µæµ‹è¯• (12)
    âœ“ åº”è¯¥å¤„ç† null ç”¨æˆ·
    âœ“ åº”è¯¥å¤„ç† undefined ç”¨æˆ·ï¼ˆåº”è¯¥è½¬æ¢ä¸º nullï¼‰
    âœ“ åº”è¯¥å¤„ç†ç©ºå­—ç¬¦ä¸² token
    ...
  âœ“ 3. å¼‚å¸¸è·¯å¾„æµ‹è¯• (8)
    âœ“ åº”è¯¥å¤„ç† localStorage.setItem æŠ›å‡ºå¼‚å¸¸ï¼ˆå­˜å‚¨é…é¢å·²æ»¡ï¼‰
    âœ“ åº”è¯¥å¤„ç† localStorage.setItem æŠ›å‡º SecurityErrorï¼ˆéšç§æ¨¡å¼ï¼‰
    ...
  âœ“ 4. æ½œåœ¨Bugæµ‹è¯• (15)
    âœ“ åº”è¯¥é˜²æ­¢çŠ¶æ€ä¸ä¸€è‡´ï¼ˆç”¨æˆ·å­˜åœ¨ä½†tokenä¸ºç©ºï¼‰
    âœ“ åº”è¯¥é˜²æ­¢tokenå­˜åœ¨ä½†ç”¨æˆ·ä¸ºç©ºï¼ˆå¼‚å¸¸çŠ¶æ€ï¼‰
    ...
  âœ“ 5. é›†æˆæµ‹è¯• (3)
    âœ“ åº”è¯¥å®Œæ•´æ¨¡æ‹Ÿç”¨æˆ·ç™»å½•æµç¨‹
    ...

Test Files  1 passed (1)
     Tests  60 passed (60)
      Time  600ms
```

---

## ğŸ” æµ‹è¯•å‘ç°çš„æ½œåœ¨é—®é¢˜

è¿™ä¸ªæµ‹è¯•å¥—ä»¶è®¾è®¡ç”¨äºå‘ç°ä»¥ä¸‹ç±»å‹çš„ Bugï¼š

1. **çŠ¶æ€ä¸ä¸€è‡´**ï¼šç”¨æˆ·å’Œ token ä¸åŒ¹é…çš„æƒ…å†µ
2. **å†…å­˜æ³„æ¼**ï¼šlocalStorage æ“ä½œå¤±è´¥ä½†çŠ¶æ€æœªæ¸…ç†
3. **ç«æ€æ¡ä»¶**ï¼šå¹¶å‘æ“ä½œå¯¼è‡´çš„çŠ¶æ€é”™è¯¯
4. **æ•°æ®æŸå**ï¼šæŒä¹…åŒ–æ•°æ®æ ¼å¼é”™è¯¯
5. **å®‰å…¨æ¼æ´**ï¼šXSS æ”»å‡»ã€æ¶æ„æ•°æ®æ³¨å…¥
6. **æ€§èƒ½é—®é¢˜**ï¼šå¤§é‡å¿«é€Ÿæ›´æ–°å¯¼è‡´çš„æ€§èƒ½ä¸‹é™
7. **è¾¹ç•Œå€¼é”™è¯¯**ï¼šnullã€undefinedã€ç©ºå­—ç¬¦ä¸²å¤„ç†ä¸å½“
8. **å¼‚å¸¸å¤„ç†ç¼ºå¤±**ï¼šlocalStorage æ“ä½œå¤±è´¥æ—¶æœªå¤„ç†

---

## ğŸ“ æµ‹è¯•ä»£ç ç»“æ„

```typescript
describe('auth-store - Bugæ‰«æå™¨æµ‹è¯•å¥—ä»¶', () => {
  beforeEach(() => {
    // æ¯ä¸ªæµ‹è¯•å‰é‡ç½®çŠ¶æ€
  });

  describe('1. æ­£å¸¸è·¯å¾„æµ‹è¯•', () => {
    // 8ä¸ªæµ‹è¯•ç”¨ä¾‹
  });

  describe('2. è¾¹ç•Œæƒ…å†µæµ‹è¯•', () => {
    // 12ä¸ªæµ‹è¯•ç”¨ä¾‹
  });

  describe('3. å¼‚å¸¸è·¯å¾„æµ‹è¯•', () => {
    // 8ä¸ªæµ‹è¯•ç”¨ä¾‹
  });

  describe('4. æ½œåœ¨Bugæµ‹è¯•', () => {
    // 15ä¸ªæµ‹è¯•ç”¨ä¾‹
  });

  describe('5. é›†æˆæµ‹è¯•', () => {
    // 3ä¸ªæµ‹è¯•ç”¨ä¾‹
  });
});
```

---

## ğŸ› ï¸ è°ƒè¯•æµ‹è¯•

### ä½¿ç”¨ console.log

```typescript
it('è°ƒè¯•æµ‹è¯•', () => {
  console.log('è°ƒè¯•ä¿¡æ¯', result.current);
  // ...
});
```

### ä½¿ç”¨è°ƒè¯•å™¨

åœ¨ VS Code ä¸­ï¼š
1. åœ¨æµ‹è¯•æ–‡ä»¶ä¸­è®¾ç½®æ–­ç‚¹
2. æ‰“å¼€ "Run and Debug"
3. é€‰æ‹© "Debug Test" é…ç½®
4. è¿è¡Œæµ‹è¯•

### æŸ¥çœ‹è¯¦ç»†è¾“å‡º

```bash
npm test -- --reporter=verbose
```

---

## ğŸ“ˆ è¦†ç›–ç‡ç›®æ ‡

- **è¯­å¥è¦†ç›–ç‡ï¼š** 100%
- **åˆ†æ”¯è¦†ç›–ç‡ï¼š** 95%+
- **å‡½æ•°è¦†ç›–ç‡ï¼š** 100%
- **è¡Œè¦†ç›–ç‡ï¼š** 100%

è¿è¡Œ `npm run test:coverage` æŸ¥çœ‹è¯¦ç»†è¦†ç›–ç‡æŠ¥å‘Šã€‚

---

## ğŸ”„ æŒç»­é›†æˆ

### GitHub Actions ç¤ºä¾‹

```yaml
name: Tests
on: [push, pull_request]
jobs:
  test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      - uses: actions/setup-node@v3
        with:
          node-version: '18'
      - run: cd frontend && npm install
      - run: cd frontend && npm run test:run
      - run: cd frontend && npm run test:coverage
```

---

## â“ å¸¸è§é—®é¢˜

### Q: æµ‹è¯•å¤±è´¥ï¼Œæç¤ºæ‰¾ä¸åˆ°æ¨¡å—ï¼Ÿ

A: ç¡®ä¿å·²å®‰è£…æ‰€æœ‰ä¾èµ–ï¼š
```bash
npm install
```

### Q: localStorage mock ä¸å·¥ä½œï¼Ÿ

A: æ¯ä¸ªæµ‹è¯•æ–‡ä»¶éƒ½æœ‰è‡ªå·±çš„ localStorage mockï¼Œç¡®ä¿åœ¨ `beforeEach` ä¸­æ­£ç¡®è®¾ç½®ã€‚

### Q: å¦‚ä½•æµ‹è¯• SSR ç¯å¢ƒï¼Ÿ

A: ä½¿ç”¨ `delete global.window` æ¨¡æ‹Ÿ SSR ç¯å¢ƒï¼Œæµ‹è¯•åè®°å¾—æ¢å¤ã€‚

### Q: å¦‚ä½•æµ‹è¯•å¤šæ ‡ç­¾é¡µåŒæ­¥ï¼Ÿ

A: ä½¿ç”¨ `StorageEvent` æ¨¡æ‹Ÿ localStorage äº‹ä»¶ï¼ŒZustand persist ä¸­é—´ä»¶ä¼šè‡ªåŠ¨å¤„ç†ã€‚

---

## ğŸ“š ç›¸å…³èµ„æº

- [Vitest æ–‡æ¡£](https://vitest.dev/)
- [React Testing Library æ–‡æ¡£](https://testing-library.com/react)
- [Zustand æ–‡æ¡£](https://github.com/pmndrs/zustand)

---

## âœ… æµ‹è¯•æ£€æŸ¥æ¸…å•

è¿è¡Œæµ‹è¯•å‰ï¼Œç¡®ä¿ï¼š

- [ ] æ‰€æœ‰ä¾èµ–å·²å®‰è£…
- [ ] Vitest é…ç½®æ­£ç¡®
- [ ] æµ‹è¯•ç¯å¢ƒè®¾ç½®å®Œæˆ
- [ ] localStorage mock å·²é…ç½®
- [ ] window å¯¹è±¡å·² mock

---

**æœ€åæ›´æ–°ï¼š** 2025å¹´1æœˆ  
**æµ‹è¯•ç»´æŠ¤è€…ï¼š** QA Team
