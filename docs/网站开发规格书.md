# 芸仔AI（Yunzai AI）网站开发规格书

> **版本**: 1.0  
> **用途**: 网站二次开发与功能加强  
> **逆向反推**: 基于现有代码库与架构整理  

---

## 目录

1. [项目概述](#1-项目概述)
2. [技术架构](#2-技术架构)
3. [数据模型与数据库](#3-数据模型与数据库)
4. [后端 API 规格](#4-后端-api-规格)
5. [前端架构与页面](#5-前端架构与页面)
6. [认证与安全](#6-认证与安全)
7. [核心业务流程](#7-核心业务流程)
8. [系统配置与扩展点](#8-系统配置与扩展点)
9. [部署与运维](#9-部署与运维)
10. [二次开发与扩展指南](#10-二次开发与扩展指南)
11. [附录](#11-附录)

---

## 1. 项目概述

### 1.1 产品定位

**芸仔AI** 是一款 **BYOK（Bring Your Own Key）** 模式的 AI SaaS 平台：

- **用户自携 API 密钥**：用户需绑定自己的大模型 API Key，平台仅作转发与编排。
- **管理员控制路由与模型**：中转站（Relay）地址、可用模型、领域目标模型均由管理员在后台配置。
- **法律合规与风控**：强制法律声明确认、资产保护（设备数限制）、敏感词过滤、聊天水印。

### 1.2 核心业务规则（必遵）

| 规则 | 说明 | 代码/配置位置 |
|------|------|----------------|
| **BYOK 模型** | 用户提供 `apiKey`，系统通过 `RelayConfig` 的 `baseUrl` 转发请求 | `WorkflowContextBuilder`、`RelayService` |
| **SSO 踢出** | 支持会话管理，可做「别处登录」踢出 | `SessionService`、`JwtStrategy`、前端 401 处理 |
| **资产保护** | 24 小时内最多 5 台设备，超限即：`LOCKED_ASSET_PROTECTION` + `apiKey` 清空 | `AssetProtectionMiddleware`、Redis 有序集合 |
| **法律声明** | 激活会员后必须手输「我承诺合法使用」并落库，否则 `LegalGateGuard` 拦截 | `LegalController`、`LegalGateGuard`、`LegalLog` |
| **水印** | 聊天界面强制展示水印 | `SystemConfig.watermark_config`、`Watermark` 组件 |

### 1.3 设计原则（豆包风格）

- **UI**：简约、圆角（`rounded-xl`/`rounded-2xl`）、轻阴影、胶囊按钮。
- **布局**：桌面 10 列密网格；移动 1–2 列。
- **色彩**：主色 Soft Blue `#0066FF`，背景白/灰。

---

## 2. 技术架构

### 2.1 技术栈

| 层级 | 技术 | 版本/说明 |
|------|------|-----------|
| **前端** | Next.js (App Router) | 14.x |
| | TypeScript | 5.x |
| | Tailwind CSS | 3.4 |
| | Shadcn/UI、Lucide Icons | - |
| | Axios、Zustand（含 persist） | - |
| **后端** | NestJS | 10.x |
| | Prisma ORM | 5.x / 6.x |
| | PostgreSQL | 15 |
| | Redis | 7 |
| **认证** | 自建 JWT（无 NextAuth） | passport-jwt、@nestjs/jwt |
| **部署** | Docker、Docker Compose | 支持 standalone 输出 |

### 2.2 项目结构

```
yunzai-ai-clean/
├── backend/                 # NestJS 后端
│   ├── src/
│   │   ├── admin/           # 管理端 API（需 AdminGuard）
│   │   ├── ai-domains/      # 公开 AI 领域接口
│   │   ├── auth/            # 登录、注册、激活、API Key、守卫、中间件
│   │   ├── chat/            # 聊天、历史、删除会话
│   │   ├── common/          # 常量、装饰器、异常、过滤器、管道、服务、工具
│   │   ├── health/          # 健康检查
│   │   ├── legal/           # 法律签署、管理端法律文本与日志
│   │   ├── prisma/          # PrismaModule、PrismaService
│   │   ├── redis/           # RedisModule、RedisService
│   │   ├── scheduler/        # 定时任务（若有）
│   │   ├── system-config/   # 公开系统配置（只读）
│   │   ├── workflow/        # 工作流执行、校验、上下文、执行器
│   │   ├── app.module.ts
│   │   └── main.ts
│   ├── Dockerfile / Dockerfile.china
│   └── package.json
├── frontend/                # Next.js 前端
│   ├── src/
│   │   ├── app/             # App Router 页面与 layout
│   │   ├── components/      # 业务组件、ui、admin、chat、modals、layout
│   │   ├── lib/             # api(axios、system-config)、constants、utils、validations
│   │   ├── stores/          # auth-store、error-modal-store
│   │   └── test/
│   ├── public/
│   ├── next.config.js
│   ├── tailwind.config.ts
│   └── package.json
├── prisma/
│   ├── schema.prisma
│   └── migrations/
├── docs/
├── docker-compose.yml       # 开发：仅 postgres + redis
├── docker-compose.prod.yml  # 生产：postgres + redis + backend + frontend
└── .cursorrules
```

### 2.3 模块依赖关系（后端）

```
AppModule
├── ConfigModule (全局)
├── PrismaModule
├── RedisModule
├── AuthModule      → JwtModule, SessionService, DeviceService
├── WorkflowModule  → WorkflowService, WorkflowValidator, WorkflowContextBuilder, WorkflowExecutor
├── ChatModule      → WorkflowService, ChatService, PrismaService
├── SystemConfigModule
├── SchedulerModule
├── LegalModule
├── AdminModule     → 依赖 AuthModule 的 JwtAuthGuard、AdminGuard
├── AIDomainsModule
└── HealthModule
```

---

## 3. 数据模型与数据库

### 3.1 Prisma 数据源

- **Provider**: `postgresql`
- **URL**: `env("DATABASE_URL")`

### 3.2 实体与关系

#### User（用户）

| 字段 | 类型 | 说明 |
|------|------|------|
| id | uuid | 主键 |
| email | string, unique | 登录邮箱 |
| passwordHash | string | bcrypt 哈希 |
| membershipExpireAt | DateTime? | 会员到期时间 |
| apiKey | string? | 用户 API 密钥（明文或加密存储，实现按项目） |
| apiBaseUrl | string? | 自定义 API 地址，**仅用于测试连接**，工作流执行不用 |
| isLegalSigned | boolean, default false | 是否完成法律签署 |
| deviceFingerprintCount | int, default 0 | 风控用设备计数 |
| status | UserStatus | ACTIVE / BANNED / LOCKED_ASSET_PROTECTION |
| registeredIp, lastLoginIp | string? | 注册/最后登录 IP |
| createdAt, updatedAt | DateTime | |

**关系**：`LegalLog`、`ChatHistory`、`Device`、`UserStatusLog`

#### UserStatus（枚举）

- `ACTIVE`、`BANNED`、`LOCKED_ASSET_PROTECTION`

#### SystemConfig（系统配置，K-V）

| 字段 | 类型 | 说明 |
|------|------|------|
| id | uuid | 主键 |
| key | string, unique | 如：site_info, scripts, announcement, contact_qr, sensitive_words, watermark_config, sidebar_menu |
| value | text | JSON 字符串 |
| updatedAt, updatedBy | DateTime?, string? | |

#### RelayConfig（中转站 / BYOK 路由）

| 字段 | 类型 | 说明 |
|------|------|------|
| id | uuid | 主键 |
| name | string | 如「云雾」 |
| baseUrl | string | 工作流请求发往的 API 根地址 |
| apiKeyLink | string? | 获取 API Key 的说明链接 |
| buyLink | string? | 购买/充值链接 |
| isActive | boolean, default true | 同时仅能一个为 true |
| availableModels | Json? | 支持的模型名数组，如 ["gpt-4","gpt-3.5-turbo"] |
| createdAt, updatedAt | DateTime | |

#### AIDomain（AI 领域 / 功能块）

| 字段 | 类型 | 说明 |
|------|------|------|
| id | uuid | 主键 |
| title | string | 展示标题 |
| description | string? | 描述 |
| icon | string? | 图标标识 |
| greetingMessage | string? | 进入该工具时的欢迎语 |
| workflowConfig | Json? | 工作流：steps、variables |
| targetModel | string? | 领域级默认模型（逐步迁移到 step 级） |
| isVisible | boolean, default true | 是否在首页展示 |
| isMaintenance | boolean, default false | 维护中 |
| sortOrder | int, default 0 | 排序 |
| createdAt, updatedAt | DateTime | |

**关系**：`ChatHistory`（domainId 可选）

#### ActivationCode（激活码）

| 字段 | 类型 | 说明 |
|------|------|------|
| code | string | 主键，激活码本身 |
| days | int | 延长会员天数 |
| batchTag | string? | 批次标签 |
| status | ActivationCodeStatus | UNUSED / USED / FROZEN |
| usedBy | string? | 使用者 userId |
| usedAt | DateTime? | |
| createdAt, updatedAt | DateTime | |

#### LegalLog（法律签署日志）

| 字段 | 类型 | 说明 |
|------|------|------|
| id | uuid | 主键 |
| userId | string | 外键 → User |
| signatureText | string | 必须与约定文案一致（如「我承诺合法使用」） |
| ip | string | |
| userAgent | string? | |
| createdAt | DateTime | |

#### ChatHistory（聊天记录）

| 字段 | 类型 | 说明 |
|------|------|------|
| id | uuid | 主键 |
| userId | string | 外键 → User |
| domainId | string? | 外键 → AIDomain |
| role | string | "user" \| "assistant" \| "system" |
| content | text | |
| metadata | Json? | 模型、token 等 |
| createdAt | DateTime | |

#### Device（设备，风控）

| 字段 | 类型 | 说明 |
|------|------|------|
| id | uuid | 主键 |
| userId | string | 外键 → User |
| fingerprint | string | 设备指纹（哈希） |
| ip | string | |
| userAgent | string? | |
| lastUsedAt | DateTime | |
| isActive | boolean | 是否当前活跃 |
| createdAt, updatedAt | DateTime | |

#### UserStatusLog（用户状态变更审计）

| 字段 | 类型 | 说明 |
|------|------|------|
| id | uuid | 主键 |
| userId | string | 外键 → User |
| previousStatus | UserStatus | |
| newStatus | UserStatus | |
| reason | string | 必填 |
| operatorEmail | string | 操作人 |
| ip | string? | |
| createdAt | DateTime | |

### 3.3 工作流配置结构（workflowConfig）

```ts
interface WorkflowConfig {
  steps: WorkflowStep[];
  variables?: Record<string, string>;
}

interface WorkflowStep {
  type: 'prompt' | 'api_call' | 'transform';
  model?: string;        // 步骤级模型，优先于 AIDomain.targetModel
  config: {
    template?: string;   // 支持 {{user_input}}、{{input}}、{{变量名}}
    endpoint?: string;   // 默认 /v1/chat/completions
    extraParams?: object;
  };
}
```

**变量替换规则**：

- `{{user_input}}`：原始用户输入
- `{{input}}`：当前步骤的输入（上一步输出）
- `{{key}}`：`variables` 中的自定义变量

---

## 4. 后端 API 规格

### 4.1 基础约定

- **Base URL**：开发 `http://localhost:3000`，生产由 `FRONTEND_URL` / `NEXT_PUBLIC_API_URL` 决定。
- **认证**：除注明「公开」外，需 `Authorization: Bearer <JWT>`。
- **Content-Type**：`application/json`。
- **错误**：使用 `GlobalExceptionFilter`，不向前端暴露原始 500；错误体含 `code`、`message`。
- **校验**：Zod + `createZodPipe`，部分沿用 `class-validator`。

### 4.2 认证 (Auth) — `POST /api/auth/*`

| 方法 | 路径 | 认证 | 说明 |
|------|------|------|------|
| POST | /api/auth/login | 否 | 登录。Body: `{ email, password?, turnstileToken?, browserFingerprint? }`。返回 `{ accessToken, user }`。 |
| POST | /api/auth/register | 否 | 注册。Body: `{ email, password, turnstileToken? }`。注册后自动登录。 |
| POST | /api/auth/me | JWT | 当前用户信息。返回 `{ id, email, membershipExpireAt, isLegalSigned, status, ... }`。 |
| POST | /api/auth/activate | JWT | 使用激活码。Body: `{ code }`。返回 `{ success, membershipExpireAt }`。 |

### 4.3 激活码 (Activation) — `POST /api/activation/*`

| 方法 | 路径 | 认证 | 说明 |
|------|------|------|------|
| POST | /api/activation/use | JWT | Body: `{ code }`，`code` 仅允许 `[A-Z0-9]+`。返回 `{ success, membershipExpireAt }`。 |

### 4.4 API 密钥 (API Key) — `GET|POST /api/api-key/*`

| 方法 | 路径 | 认证 | 说明 |
|------|------|------|------|
| GET | /api/api-key/status | JWT | `{ hasApiKey, isConfigured, apiBaseUrl }`，不暴露密钥。 |
| POST | /api/api-key/set | JWT | Body: `{ apiKey, apiBaseUrl? }`。apiKey 长度 10–500；apiBaseUrl 需合法 URL。 |
| POST | /api/api-key/delete | JWT | 清空 `apiKey`、`apiBaseUrl`。 |
| POST | /api/api-key/test | JWT | Body: `{ apiKey?, apiBaseUrl? }`。可含占位符用已存密钥；apiBaseUrl 可选，否则用 Relay 或 `https://api.openai.com`。请求 `GET /v1/models` 校验。 |

### 4.5 法律 (Legal) — `POST /api/legal/*`

| 方法 | 路径 | 认证 | 说明 |
|------|------|------|------|
| POST | /api/legal/sign | JWT | Body: `{ signatureText, ip, userAgent? }`。`signatureText` 需与后台约定完全一致。 |

### 4.6 聊天 (Chat) — `GET|POST|DELETE /api/chat/*`

**前置**：`JwtAuthGuard`；发送消息需额外 `LegalGateGuard`（会员 + 已签署法律）。

| 方法 | 路径 | 认证 | 说明 |
|------|------|------|------|
| POST | /api/chat | JWT + LegalGate | Body: `{ domainId (uuid), message?, images?: [{ data, mimeType, filename? }] }`。`message` 与 `images` 至少一项。执行工作流并落库，返回 `{ success, data: { message } }`。支持多会话并发。 |
| GET | /api/chat/history | JWT | Query: `domainId?`。返回会话列表，以 30 分钟无消息为会话分界；每条会话以首条 user 消息 id 为 `id`。 |
| GET | /api/chat/messages | JWT | Query: `domainId?` 或 `historyId?`。`historyId` 为首条 user 消息 id，取同会话（同 domain、30 分钟窗口）消息。 |
| DELETE | /api/chat/history/:historyId | JWT | 删除以 `historyId` 为起点的整段会话。返回 `{ success, message, deletedCount }`。 |

### 4.7 AI 领域 (公开) — `GET /api/ai-domains/*`

| 方法 | 路径 | 认证 | 说明 |
|------|------|------|------|
| GET | /api/ai-domains | 否 | 可见且非维护中的领域列表。 |
| GET | /api/ai-domains/active-relay | 否 | 当前激活 Relay：`{ name, baseUrl, apiKeyLink, buyLink }`。 |
| GET | /api/ai-domains/:id | 否 | 单个领域详情。 |

### 4.8 系统配置 (公开) — `GET /api/system-config`

| 方法 | 路径 | 认证 | 说明 |
|------|------|------|------|
| GET | /api/system-config | 否 | 返回 `[{ key, value }]`，value 多为 JSON 字符串。 |

### 4.9 管理端 (Admin) — `GET|POST|PUT|DELETE /api/admin/*`

**前置**：`JwtAuthGuard` + `AdminGuard`。Admin 规则：`email` 含 `admin`（大小写不敏感）。

#### 9.1 AI 领域管理

| 方法 | 路径 | 说明 |
|------|------|------|
| GET | /api/admin/ai-domains | 全部领域，按 sortOrder。 |
| POST | /api/admin/ai-domains | Body: title, description?, icon?, greetingMessage?, workflowConfig?, targetModel?, isVisible?, isMaintenance?, sortOrder?。 |
| PUT | /api/admin/ai-domains/:id | 同上字段，均可选。 |
| DELETE | /api/admin/ai-domains/:id | 删除领域。 |

#### 9.2 激活码管理

| 方法 | 路径 | 说明 |
|------|------|------|
| GET | /api/admin/activation-codes | Query: status?, batchTag?, page?, limit?。返回 `{ codes, total, page, limit, totalPages }`，codes 含 `usedByEmail`。 |
| POST | /api/admin/activation-codes/generate | Body: `{ count (1–1000), days, batchTag? }`。返回 `{ codes, count }`。 |
| PUT | /api/admin/activation-codes/:code/status | Body: `{ status: UNUSED|USED|FROZEN }`。 |

#### 9.3 系统配置

| 方法 | 路径 | 说明 |
|------|------|------|
| GET | /api/admin/system-config | 以 `{ key: 解析后value }` 对象返回。 |
| PUT | /api/admin/system-config | Body: `Record<string, unknown>`，批量 upsert，value 做 `JSON.stringify`。 |

#### 9.4 统计

| 方法 | 路径 | 说明 |
|------|------|------|
| GET | /api/admin/stats | `{ dailyRegisters, activeMembers, apiUsage }`（今日注册、有效会员、今日 user 消息数）。 |

#### 9.5 用户管理

| 方法 | 路径 | 说明 |
|------|------|------|
| GET | /api/admin/users | Query: status?, membershipStatus?, search?, page?, limit?。membershipStatus: member|non-member|expired。 |
| GET | /api/admin/users/:id | 用户详情，含 legalLogs、chatHistories、devices、activationCodes、statusLogs、membershipActivatedAt。 |
| PUT | /api/admin/users/:id/status | Body: `{ status, reason }`。会写 `UserStatusLog`。 |
| PUT | /api/admin/users/:id/membership | **已禁用**，返回 403，会员仅能通过激活码。 |

#### 9.6 中转站 (Relay) 管理

| 方法 | 路径 | 说明 |
|------|------|------|
| GET | /api/admin/relay-configs | 全部 Relay。 |
| GET | /api/admin/relay-configs/active/models | 当前激活 Relay 的 `availableModels`，供工作流编辑器用。 |
| POST | /api/admin/relay-configs | Body: name, baseUrl, apiKeyLink?, buyLink?, isActive?, availableModels?。若 isActive 则先将其它置为 false；激活时需 availableModels 至少 1 个。 |
| PUT | /api/admin/relay-configs/:id | 更新；切换 isActive 时同样会校验模型、提示不兼容领域。 |
| DELETE | /api/admin/relay-configs/:id | 删除。 |

### 4.10 管理端 - 法律 (Admin Legal)

| 方法 | 路径 | 说明 |
|------|------|------|
| GET | /api/admin/legal/text | 法律声明全文。 |
| PUT | /api/admin/legal/text | Body: `{ text }`。 |
| GET | /api/admin/legal/logs | Query: email?, page?, limit?。签署日志。 |

### 4.11 管理端 - 工作流测试

| 方法 | 路径 | 说明 |
|------|------|------|
| POST | /api/admin/workflow/test | JWT + LegalGate。Body: `{ domainId, userInput }`。执行工作流但不写 ChatHistory，返回 `{ success, data: { result, message } }`。 |

### 4.12 健康检查

| 方法 | 路径 | 认证 | 说明 |
|------|------|------|------|
| GET | /health | 否 | 健康检查，供负载均衡/Docker 使用。 |

### 4.13 Swagger

- **路径**：`/api/docs`
- **Bearer**：`JWT-auth`。

---

## 5. 前端架构与页面

### 5.1 技术要点

- **Next.js 14**，App Router，`output: 'standalone'` 以配合 Docker。
- **Tailwind**：`tailwind.config.ts` 扩展 primary、shadow、rounded；`globals.css` 定义 `:root` 与 `prose`。
- **Shadcn/UI**：`avatar`、`badge`、`button`、`card`、`checkbox`、`dialog`、`drawer`、`input`、`label`、`progress`、`select`、`switch`、`textarea`。
- **状态**：Zustand + `persist`（`auth-storage`）、`error-modal-store`。
- **请求**：`lib/api/axios` 封装 Axios，统一加 `Authorization`、401/402/403/429/500 与 `X-Device-Warning` 处理，以及重试（最多 3 次，指数退避）。

### 5.2 环境变量

- `NEXT_PUBLIC_API_URL`：后端地址，默认 `http://localhost:3000`。

### 5.3 路由与页面

| 路径 | 说明 | 组件/入口 |
|------|------|-----------|
| / | 首页 | `HomePage`，展示 AI 领域、公告等 |
| /login | 用户登录 | `AuthForm` |
| /register | 用户注册 | `AuthForm` |
| /chat/[id] | 聊天（id 为 domainId） | `ChatPage` |
| /settings | 用户设置（API Key、会员等） | `settings/page` |
| /admin/login | 管理端登录 | 独立登录页 |
| /admin | 管理端首页 / Dashboard | `Dashboard` |
| /admin/activation | 激活码工厂 | `ActivationCodeFactory` |
| /admin/config | 系统配置 | `SystemConfigEditor` |
| /admin/legal | 法律文本 | `LegalCMS` |
| /admin/legal-logs | 法律日志 | `LegalLogsViewer` |
| /admin/relay | 中转站 | `RelayConfigManagement` |
| /admin/users | 用户管理 | `UserManagement` |
| /admin/workflow | 工作流编辑 | `WorkflowEditor` |

### 5.4 关键组件

| 组件 | 用途 |
|------|------|
| `AuthForm`、`AuthModal` | 登录/注册表单与弹窗 |
| `ChatInput`、`ChatMessages`、`ChatSidebar`、`MessageBubble`、`MarkdownRenderer`、`StreamingIndicator`、`SuggestedPrompts` | 聊天相关 |
| `Disclaimer`、`Watermark` | 免责声明、水印 |
| `ApiKeyModal`、`LegalAffidavitModal`、`KeyBalanceModal`、`AccountLockedModal`、`DeviceWarningModal`、`KickOutModal`、`MembershipRequiredModal`、`PricingModal`、`StrictAgreementModal` | 各类业务弹窗 |
| `UserHeader` | 顶栏用户信息与入口 |
| `AdminLayout`、`WorkflowEditor`、`WorkflowEditorView`、`useWorkflowEditor` | 管理端布局与工作流 |
| `ErrorBoundary` | 全局错误边界 |
| `Turnstile` | 人机验证（若启用） |

### 5.5 前端 SystemConfig 使用

`getSystemConfig()` 请求 `/api/system-config`，转成对象。常用 key：

- `site_info`：`{ title, description, keywords }`
- `scripts`：`{ head, body }`
- `announcement`、`contact_qr`
- `sensitive_words`：`string[]`（仅后端过滤，前端可选展示）
- `watermark_config`：`{ enabled, text }`
- `sidebar_menu`：侧栏/首页菜单配置

---

## 6. 认证与安全

### 6.1 JWT

- **Payload**：含 `userId`、`sessionId`、`email` 等；由 `SessionService` 与 `JwtService` 生成。
- **Redis 会话**：`SessionService` 在 Redis 存会话，`JwtStrategy` 校验时查 Redis；过期、踢出会清会话。
- **开发降级**：Redis 不可用时，仅校验 JWT 签名，不强制查 Redis（视 `SessionService` 实现）。

### 6.2 守卫

| 守卫 | 作用 |
|------|------|
| `JwtAuthGuard` | 校验 JWT，并将 `user` 挂到 `req.user`（含 `userId`、`sessionId` 等）。 |
| `AdminGuard` | 要求 `req.user.email` 含 `admin`（不区分大小写）。 |
| `LegalGateGuard` | 要求会员有效且 `isLegalSigned === true`，否则抛 `MembershipRequiredException` 或 `LegalGateBlockedException`。 |

### 6.3 资产保护中间件 (AssetProtectionMiddleware)

- **逻辑**：24 小时滑动窗口内，按设备指纹（IP+UA+Accept-* 等构造）在 Redis 有序集合中计数。
- **上限**：5 台设备；超过即：`User.status=LOCKED_ASSET_PROTECTION`、`User.apiKey=null`，并抛 `AssetProtectionTriggeredException`。
- **预警**：3 或 4 台时写响应头 `X-Device-Warning: YELLOW:n`，前端 `error-modal-store` 可弹设备警告。
- **作用范围**：在 `AuthModule` 中挂到需要保护的路由（如 `/api/chat`、`/api/api-key` 等）。

### 6.4 安全与工程规范

- **Helmet**：`main.ts` 已启用，CSP、COEP 等按需关闭以便接入外部资源。
- **CORS**：仅允许 `FRONTEND_URL`（默认 `http://localhost:3001`），`credentials: true`。
- **Trust proxy**：`express.set('trust proxy', true)` 以便取 `X-Forwarded-For`。
- **全局异常**：`GlobalExceptionFilter` 捕获后，对 500 等返回统一结构，不泄露堆栈。
- **校验**：Zod 为主；`Whitelist`、`forbidNonWhitelisted`、`transform` 在 `ValidationPipe` 中启用。

---

## 7. 核心业务流程

### 7.1 BYOK 与中转站（详见 `docs/BYOK和中转站控制逻辑说明.md`）

- **baseUrl**：工作流执行**仅**用 `RelayConfig.baseUrl`（当前 isActive 的 Relay），**不用** `User.apiBaseUrl`。
- **apiKey**：一律用 `User.apiKey`。
- **apiBaseUrl**：仅用于「测试连接」接口；工作流、聊天不读取。
- **模型**：`RelayConfig.availableModels` 限制工作流可选模型；`AIDomain.targetModel` 或 `WorkflowStep.model` 决定实际调用模型；执行前 `WorkflowValidator.validateModels` 再次校验。
- **扩展**：若将来允许 `User.apiBaseUrl` 参与工作流，需在 `WorkflowContextBuilder.build` 中明确与 `RelayConfig.baseUrl` 的优先级，并同步更新 BYOK 文档与管理员说明。

### 7.2 工作流执行链

1. **ChatController** 收 `domainId`、`message`、`images?`，调 `WorkflowService.executeWorkflow`。
2. **WorkflowService**：  
   - `WorkflowInputValidator`：userInput、domainId、images、workflow 结构、step、model、endpoint。  
   - `WorkflowValidator.checkSensitiveWords`：查 `SystemConfig.sensitive_words`。  
   - `WorkflowValidator.validateAndLoadConfig`：取 `AIDomain.workflowConfig`，校验 steps 非空。  
   - `WorkflowValidator.validateModels`：step 的 model 必须在 `RelayConfig.availableModels` 中。  
   - `WorkflowContextBuilder.build`：domain、Relay、User（apiKey；baseUrl 取自 Relay），组装 `WorkflowExecutionContext`。  
   - `WorkflowExecutor.execute`：顺序执行 steps；`prompt`/`api_call` 做模板替换与 `POST /v1/chat/completions`（或 `config.endpoint`）调用；`transform` 按实现处理。
3. 返回最后一 step 的文本；**ChatService.saveChatMessages** 在事务中写入 user 与 assistant 两条 `ChatHistory`。

### 7.3 会话与历史

- **会话界定**：同一 `domainId` 下，相邻两条 user 消息间隔 **>30 分钟** 则视为新会话。
- **historyId**：以该会话**首条 user 消息的 id** 作为 `historyId`，用于 `GET /api/chat/messages?historyId=` 和 `DELETE /api/chat/history/:historyId`。

### 7.4 法律门禁与会员

- **会员**：`membershipExpireAt > now` 视为有效。
- **LegalGateGuard**：先判会员，非会员 → `MembershipRequiredException`；会员但 `!isLegalSigned` → `LegalGateBlockedException`。
- **签署**：`POST /api/legal/sign`，`signatureText` 需与后台配置完全一致，写入 `LegalLog`，并更新 `User.isLegalSigned`。

### 7.5 激活码

- **使用**：`ActivationService.useActivationCode`：查 `ActivationCode`（status=UNUSED、格式合规），若 `membershipExpireAt` 已过期则以当前时间为起点，否则在原基础上加 `days` 天；更新 `usedBy`、`usedAt`、status=USED，回写 `User.membershipExpireAt`。

---

## 8. 系统配置与扩展点

### 8.1 SystemConfig 的 key

| key | 用途 | 备注 |
|-----|------|------|
| site_info | 站点名称、描述、关键词 | 用于 title、meta |
| scripts | head/body 注入脚本 | 统计、客服等 |
| announcement | 公告内容 | 首页等 |
| contact_qr | 联系方式/二维码 | 图片 URL 或 base64 |
| sensitive_words | 敏感词列表 | JSON 数组，工作流执行前过滤 |
| watermark_config | 水印开关与文案 | `{ enabled, text }` |
| sidebar_menu | 首页/侧栏菜单结构 | 自定义菜单 JSON |

### 8.2 工作流步骤扩展

- 当前 `WorkflowExecutor` 主要实现 `api_call`（OpenAI 兼容 `/v1/chat/completions`），`prompt` 作模板替换后接入 `api_call`。
- 新增 `type`（如 `http`、`script`）需：在 `workflow-input.validator` 加 step 校验，在 `WorkflowExecutor.executeStep` 加分支；若调用外部 API，需统一错误映射（401→UpstreamUnauthorized 等）。

### 8.3 错误码

见 `backend/src/common/constants/error-codes.ts`。前端 `lib/constants/error-codes.ts` 可做镜像，用于 401/403 的 `code` 分支（如 `SESSION_EXPIRED`、`ASSET_PROTECTION_TRIGGERED`、`LEGAL_GATE_BLOCKED`、`MEMBERSHIP_REQUIRED`）。

---

## 9. 部署与运维

### 9.1 环境变量（后端）

| 变量 | 必填 | 说明 |
|------|------|------|
| DATABASE_URL | 是 | PostgreSQL 连接串 |
| REDIS_URL | 是 | Redis 连接串；Redis 不可用时资产保护、会话校验会降级 |
| JWT_SECRET | 是 | JWT 签名密钥 |
| PORT | 否 | 默认 3000 |
| NODE_ENV | 否 | production / development |
| FRONTEND_URL | 否 | CORS 来源，默认 http://localhost:3001 |

### 9.2 环境变量（前端）

| 变量 | 必填 | 说明 |
|------|------|------|
| NEXT_PUBLIC_API_URL | 否 | 后端 API 根地址，默认 http://localhost:3000 |

### 9.3 Docker

- **开发**：`docker-compose.yml` 仅起 postgres、redis；前后端本地 `npm run dev` / `nest start --watch`。
- **生产**：`docker-compose.prod.yml` 含 postgres、redis、backend、frontend；backend 依赖 db、redis 健康检查；frontend 依赖 backend。
- **后端 Dockerfile**：构建 Nest，运行 `node dist/src/main`；如需国内镜像可参考 `Dockerfile.china`。
- **前端 Dockerfile**：`next build` 且 `output: 'standalone'`，运行 `node .next/standalone/server.js` 等；端口 3001。

### 9.4 数据库迁移

```bash
cd backend
npx prisma migrate dev --schema=../prisma/schema.prisma   # 开发
npx prisma migrate deploy --schema=../prisma/schema.prisma # 生产
npx prisma generate --schema=../prisma/schema.prisma
```

### 9.5 健康检查

- 后端：`GET /health`
- 前端：`GET /` 或约定路径；`docker-compose.prod.yml` 中已配 `healthcheck`。

---

## 10. 二次开发与扩展指南

### 10.1 新增 API 的推荐步骤

1. 在对应模块下新增或扩展现有 `*.controller.ts`，使用 `@UseGuards(JwtAuthGuard)` 等。
2. 若需 Body/Query 校验，用 `z.object()` + `createZodPipe`，或 `class-validator`。
3. 业务逻辑放入 `*.service.ts`，在 `*Module` 的 `providers` 中注册。
4. 错误优先用 `common/exceptions` 中的自定义异常，或 `HttpException`，由 `GlobalExceptionFilter` 统一格式化。
5. 在 Swagger 上补充 `@ApiTags`、`@ApiOperation`、`@ApiBody`、`@ApiResponse` 等。

### 10.2 新增数据表/字段

1. 修改 `prisma/schema.prisma`，补 `model` 或字段。
2. `prisma migrate dev --name 描述` 生成迁移；检查 `migrations/*.sql`。
3. `prisma generate`；在 Service 中通过 `PrismaService` 使用新模型。

### 10.3 新增工作流步骤类型

1. 在 `workflow-input.validator` 的 `validateStepConfig` 中允许新 `type` 及对应 `config` 形状。
2. 在 `WorkflowExecutor.executeStep` 中根据 `step.type` 分支，实现新逻辑；若调外部 API，复用或扩展 `executeApiCallStep` 的错误映射。
3. 管理端 `WorkflowEditor` 若需可视化，在 `WorkflowEditorView`、`useWorkflowEditor` 中加节点/配置 UI。

### 10.4 新增系统配置项

1. 在 `SystemConfig` 中约定新 `key`（如 `xxx_config`）。
2. 管理端 `SystemConfigEditor` 或单独配置页增加编辑；保存走 `PUT /api/admin/system-config`。
3. 前端在 `getSystemConfig()` 后读取对应 key，在相应页面/组件中使用。

### 10.5 新增错误码与前端处理

1. 在 `backend/.../error-codes.ts` 增加常量。
2. 在 `GlobalExceptionFilter` 或具体 Service 中按业务抛出带 `code` 的异常。
3. 前端 `lib/api/axios` 的 `handleHttpError` 或 `error-modal-store` 中根据 `data.code` 分支，决定 toasts、弹窗或跳转。

### 10.6 前端新增页面/模块

1. 在 `app/` 下新建 `page.tsx` 或 `[param]/page.tsx`。
2. 若需鉴权，在服务端或客户端根据 `auth-store` / `api.get('/api/auth/me')` 做重定向。
3. 管理端页面放在 `app/admin/`，并使用 `AdminLayout`，侧栏可在 `sidebar_menu` 或布局组件中配置。

### 10.7 可扩展点摘要

| 扩展点 | 位置 | 说明 |
|--------|------|------|
| 新 API 模块 | `backend/src/` | 新建 Module、Controller、Service，在 `AppModule` 中 import |
| 新守卫/管道/过滤器 | `common/` | 在 Controller 或 `main.ts` 全局挂载 |
| 新 SystemConfig key | DB + 管理端 + 前端 `getSystemConfig` | 需同步约定 key 与 JSON 结构 |
| 工作流步骤 type | `WorkflowExecutor`、`workflow-input.validator`、WorkflowEditor | 需同时改校验、执行与 UI |
| 新错误码与前端处理 | `error-codes.ts`、`GlobalExceptionFilter`、`axios` 拦截器、`error-modal-store` | 保持前后端 code 一致 |
| 新管理端菜单/页 | `app/admin/`、`AdminLayout`、`sidebar_menu` | 按现有模式新增 |

---

## 11. 附录

### 11.1 相关文档

- `API文档说明.md`：API 文档现状与 Swagger 建议  
- `docs/BYOK和中转站控制逻辑说明.md`：BYOK 与 Relay 逻辑  
- `docs/配置指南.md`、`docs/常见问题.md`、`docs/Docker安装指南.md` 等  

### 11.2 管理员账户约定

- 当前实现：`email` 包含 `admin`（不区分大小写）即视为管理员；如 `admin@example.com`、`xxx@admin.com`。
- 首次管理员需在 DB 中手动创建或通过 `scripts/create-admin-user.ts` 等脚本创建。

### 11.3 工作流配置示例（workflowConfig）

```json
{
  "steps": [
    {
      "type": "prompt",
      "model": "gpt-3.5-turbo",
      "config": {
        "template": "你是一个助手。用户说：\n\n{{user_input}}",
        "endpoint": "/v1/chat/completions"
      }
    }
  ],
  "variables": {}
}
```

### 11.4 版本与修订

- 文档版本：1.0  
- 基于仓库状态整理；后续 schema、API、前端路由若有变更，请在本规格书中同步修订，并注明日期与修改点。

---

**文档结束**
