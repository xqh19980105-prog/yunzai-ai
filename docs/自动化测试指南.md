# 自动化测试指南

本指南介绍如何在代码修改后自动检测网站是否正常工作，避免修改代码后不知道网站出现错误。

## 🚀 快速开始

### 方式一：监听模式（推荐）

在代码修改后自动运行测试：

```bash
npm run test:watch
```

或者：

```bash
tsx scripts/auto-test.ts --watch
```

这会：
- 监听 `server/`、`client/src/`、`shared/` 目录的文件变化
- 检测到文件变化后，等待 2 秒（防抖）自动运行测试
- 显示测试结果，如果有错误会高亮显示

### 方式二：单次测试

手动运行一次完整测试：

```bash
npm run test:quick
```

或者：

```bash
tsx scripts/auto-test.ts
```

### 方式三：集成到开发流程

#### 在 VS Code 中自动运行

1. 打开 VS Code
2. 按 `Ctrl+Shift+P` (Windows) 或 `Cmd+Shift+P` (Mac)
3. 输入 "Tasks: Run Task"
4. 选择 "自动测试（监听模式）"

或者配置为项目打开时自动运行（已配置在 `.vscode/tasks.json`）。

#### 使用 nodemon（可选）

```bash
# 安装 nodemon（如果还没有）
npm install -g nodemon

# 监听文件变化并运行测试
nodemon --watch server --watch client/src --watch shared --exec "npm run test:quick"
```

## 📋 测试内容

自动化测试脚本会检查以下内容：

### 1. 后端健康检查
- ✅ 后端服务器是否运行
- ✅ `/health` 接口是否正常响应

### 2. 后端 API 路由
- ✅ tRPC API 路由是否可访问
- ✅ API 响应格式是否正确

### 3. 前端页面可访问性
- ✅ 前端服务器是否运行（如果运行）
- ✅ 前端页面是否可以访问

### 4. 数据库连接
- ✅ 数据库连接是否正常
- ✅ 数据库查询是否正常

### 5. 核心 API 功能
- ✅ 发送验证码 API
- ✅ 工具列表 API
- ✅ 其他关键 API

### 6. TypeScript 类型检查
- ✅ 关键文件的 TypeScript 编译是否通过
- ✅ 类型错误检测

## 🎯 使用场景

### 场景 1：开发时自动检测

在开发过程中，保持监听模式运行：

```bash
# 终端 1: 启动开发服务器
npm run dev

# 终端 2: 启动自动测试监听
npm run test:watch
```

这样，每次保存文件后，测试会自动运行，如果发现问题会立即提示。

### 场景 2：提交代码前检查

在提交代码前，运行一次完整测试：

```bash
npm run test:quick
```

确保所有测试通过后再提交。

### 场景 3：CI/CD 集成

在 CI/CD 流程中，可以添加测试步骤：

```yaml
# .github/workflows/test.yml (示例)
- name: Run automated tests
  run: npm run test:quick
```

## ⚙️ 配置

### 环境变量

可以通过环境变量配置测试参数：

```bash
# .env 或环境变量
TEST_URL=http://127.0.0.1:3000        # 后端地址
FRONTEND_URL=http://localhost:5173    # 前端地址
TEST_EMAIL=test@example.com           # 测试邮箱
TEST_PASSWORD=test123456              # 测试密码
```

### 修改监听目录

编辑 `scripts/auto-test.ts`，修改 `watchDirs` 数组：

```typescript
const watchDirs = [
  resolve(__dirname, "../server"),
  resolve(__dirname, "../client/src"),
  resolve(__dirname, "../shared"),
  // 添加更多目录...
];
```

### 添加自定义测试

在 `scripts/auto-test.ts` 的 `runAllTests` 函数中添加新的测试：

```typescript
// 添加新测试
results.push(
  await runTest("我的自定义测试", async () => {
    // 测试逻辑
    const response = await fetch(`${BACKEND_URL}/api/my-endpoint`);
    if (!response.ok) {
      throw new Error("测试失败");
    }
  })
);
```

## 📊 测试结果解读

### 成功示例

```
============================================================
📊 测试结果
============================================================
✅ 后端健康检查: 通过 (45ms)
✅ 后端 API 路由: 通过 (32ms)
✅ 前端页面可访问性: 通过 (28ms)
✅ 数据库连接: 通过 (156ms)
✅ 发送验证码 API: 通过 (234ms)
✅ 工具列表 API: 通过 (67ms)
✅ TypeScript 类型检查: 通过 (1234ms)

============================================================
总计: 7 个测试
✅ 通过: 7
❌ 失败: 0
============================================================

🎉 所有测试通过！
```

### 失败示例

```
============================================================
📊 测试结果
============================================================
✅ 后端健康检查: 通过 (45ms)
❌ 后端 API 路由: 失败 (5000ms)
   错误: API 路由异常: 500
✅ 前端页面可访问性: 通过 (28ms)
...

============================================================
总计: 7 个测试
✅ 通过: 5
❌ 失败: 2
============================================================

⚠️  部分测试失败，请检查上述错误信息
```

## 🔧 故障排除

### 问题 1: 测试运行太慢

**原因**: 测试包含 TypeScript 编译检查，可能较慢

**解决**: 
- 跳过 TypeScript 检查（修改脚本）
- 只测试关键功能
- 使用更快的测试模式

### 问题 2: 测试失败但网站正常

**原因**: 
- 服务器未启动
- 端口配置错误
- 网络问题

**解决**:
```bash
# 确保服务器运行
npm run dev:backend

# 检查端口
netstat -ano | findstr :3000
```

### 问题 3: 监听模式不工作

**原因**: 
- 文件系统监听限制
- 权限问题

**解决**:
- 使用单次测试模式
- 检查文件权限
- 重启编辑器

### 问题 4: 测试超时

**原因**: 
- 服务器响应慢
- 网络延迟

**解决**:
- 增加超时时间（修改脚本中的 `timeout` 参数）
- 检查服务器性能
- 优化数据库查询

## 💡 最佳实践

1. **开发时保持监听模式运行**
   - 在开发过程中，保持 `npm run test:watch` 运行
   - 这样可以及时发现错误

2. **提交前运行完整测试**
   - 在提交代码前，运行 `npm run test:quick`
   - 确保所有测试通过

3. **关注测试结果**
   - 如果测试失败，立即修复
   - 不要忽略测试警告

4. **定期更新测试**
   - 添加新功能时，添加相应的测试
   - 保持测试覆盖关键功能

5. **使用 CI/CD**
   - 在 CI/CD 流程中集成自动化测试
   - 确保代码质量

## 📚 相关文档

- [测试指南](./测试指南.md) - 手动测试指南
- [配置指南](./配置指南.md) - 环境配置
- [常见问题](./常见问题.md) - 常见问题解答

## 🎓 进阶使用

### 集成到 Git Hooks

在 `.git/hooks/pre-commit` 中添加：

```bash
#!/bin/sh
npm run test:quick
if [ $? -ne 0 ]; then
  echo "测试失败，提交已取消"
  exit 1
fi
```

### 使用 GitHub Actions

创建 `.github/workflows/test.yml`:

```yaml
name: Automated Tests

on: [push, pull_request]

jobs:
  test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v2
      - uses: actions/setup-node@v2
        with:
          node-version: '18'
      - run: npm install
      - run: npm run test:quick
```

## 🚨 注意事项

1. **测试需要服务器运行**
   - 大部分测试需要后端服务器运行
   - 确保在运行测试前启动服务器

2. **测试可能影响开发**
   - 监听模式会占用一些资源
   - 如果觉得影响开发，可以只在需要时运行

3. **测试不是万能的**
   - 自动化测试主要检查基本功能
   - 复杂的功能仍需要手动测试

4. **定期更新测试**
   - 随着功能增加，更新测试用例
   - 保持测试的准确性
