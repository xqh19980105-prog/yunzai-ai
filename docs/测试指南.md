# 测试指南

本指南将帮助您测试网站的各项功能。

## 📋 测试前准备

### 1. 检查启动条件

运行启动条件检查脚本：

```bash
tsx scripts/check-startup-conditions.ts
```

这会检查：
- `.env` 文件是否存在
- 必需的环境变量是否配置
- 数据库连接是否正常
- 端口是否可用

### 2. 确保数据库已配置

```bash
# 如果还没有配置，运行：
npm run setup:local

# 或者手动复制并配置：
cp env.example .env
# 然后编辑 .env 文件，设置 DATABASE_URL 等变量
```

### 3. 运行数据库迁移

```bash
npm run db:push
```

## 🚀 启动开发服务器

### 方式一：同时启动前后端（推荐）

```bash
npm run dev
```

这会同时启动：
- **后端服务器**: http://localhost:3000
- **前端服务器**: http://localhost:5173

### 方式二：分别启动

```bash
# 终端 1: 启动后端
npm run dev:backend

# 终端 2: 启动前端
npm run dev:vite
```

## 🧪 功能测试

### 1. 访问网站

打开浏览器访问：
- **前端网站**: http://localhost:5173
- **后端登录页**: http://localhost:3000

### 2. 健康检查

```bash
# 在浏览器或使用 curl
curl http://localhost:3000/health
```

应该返回：
```json
{
  "status": "ok",
  "timestamp": "2024-..."
}
```

### 3. 测试登录功能

#### 方式一：使用邮箱+密码登录

1. 确保有测试用户（可以通过数据库或脚本创建）
2. 在前端登录页面输入邮箱和密码
3. 检查是否成功登录并跳转

#### 方式二：使用邮箱验证码登录

1. 在前端登录页面输入邮箱
2. 点击"发送验证码"
3. 输入收到的验证码（如果邮箱未配置，会在控制台显示验证码）
4. 检查是否成功登录

#### 方式三：使用测试脚本

```bash
# 测试邮箱登录
tsx scripts/test-login.ts

# 测试验证码登录
tsx scripts/test-code-login.ts

# 测试发送验证码
tsx scripts/test-send-code.ts

# 完整验证登录功能
tsx scripts/verify-login-complete.ts
```

### 4. 测试 AI 聊天功能

1. 登录后，访问聊天页面
2. 选择一个 AI 工具
3. 发送消息，检查是否收到回复
4. 检查对话历史是否保存

### 5. 测试激活码功能

1. 登录用户账户
2. 进入激活码输入页面
3. 输入测试激活码
4. 检查激活状态是否更新

### 6. 测试支付订单功能

1. 创建支付订单
2. 上传支付凭证
3. 检查订单状态变化

### 7. 测试管理员功能

1. 使用管理员账户登录
2. 访问管理员页面 (http://localhost:5173/admin)
3. 测试：
   - 查看订单列表
   - 审核订单
   - 创建激活码
   - 查看激活码列表

## 🔧 单元测试（如果配置了）

```bash
npm test
```

## 📊 测试检查清单

### 基础功能
- [ ] 服务器正常启动
- [ ] 健康检查接口正常
- [ ] 前端页面正常加载
- [ ] 数据库连接正常

### 认证功能
- [ ] 邮箱+密码登录
- [ ] 邮箱验证码登录
- [ ] 验证码发送功能
- [ ] 登出功能
- [ ] Session 保持

### 用户功能
- [ ] 查看工具列表
- [ ] 创建对话
- [ ] AI 聊天
- [ ] 查看对话历史
- [ ] 删除对话
- [ ] 激活码激活

### 支付功能
- [ ] 创建订单
- [ ] 上传支付凭证
- [ ] 查看订单状态
- [ ] 自动激活（如果配置）

### 管理员功能
- [ ] 查看所有订单
- [ ] 审核订单
- [ ] 创建激活码
- [ ] 查看激活码列表
- [ ] 用户管理

## 🐛 常见测试问题

### 1. 数据库连接失败

**问题**: 无法连接到数据库

**解决**:
```bash
# 检查 DATABASE_URL 配置
tsx scripts/check-startup-conditions.ts

# 测试数据库连接
mysql -u username -p -h localhost database_name
```

### 2. 端口被占用

**问题**: 端口 3000 或 5173 已被占用

**解决**:
```bash
# Windows PowerShell
netstat -ano | findstr :3000
taskkill /PID <进程ID> /F

# 或修改 .env 中的 PORT
```

### 3. 验证码无法发送

**问题**: 邮箱验证码发送失败

**解决**:
- 检查邮箱配置（如果启用 EMAIL_ENABLED=true）
- 如果未配置邮箱，验证码会在控制台输出（仅开发环境）

### 4. 前端无法连接后端

**问题**: 前端 API 请求失败

**解决**:
- 确保后端服务器正在运行
- 检查 CORS 配置
- 检查浏览器控制台的错误信息

### 5. 登录后跳转错误

**问题**: 登录后跳转到错误页面

**解决**:
- 检查登录成功后的重定向逻辑
- 检查路由配置
- 查看浏览器网络请求

## 🔍 调试技巧

### 1. 查看服务器日志

启动服务器时，注意观察控制台输出：
- 数据库连接状态
- API 请求日志
- 错误信息

### 2. 使用浏览器开发者工具

- **Console**: 查看前端错误和日志
- **Network**: 查看 API 请求和响应
- **Application**: 查看 Cookies 和 LocalStorage

### 3. 检查数据库状态

```bash
# 连接数据库
mysql -u root -p

# 查看用户表
USE yunzai_ai;
SELECT * FROM users;
SELECT * FROM phoneVerificationCodes;
```

### 4. 使用测试脚本

项目提供了多个测试脚本，可以快速测试特定功能：

```bash
# 测试用户是否存在
npm run check:user

# 测试登录 API
tsx scripts/test-login-api.ts

# 测试发送验证码
tsx scripts/test-send-code.ts
```

## 📝 测试报告模板

测试完成后，可以记录以下信息：

```
测试日期: YYYY-MM-DD
测试环境: 开发/生产
测试人员: 姓名

功能测试结果:
- 登录功能: ✅/❌
- 聊天功能: ✅/❌
- 支付功能: ✅/❌
- 管理功能: ✅/❌

发现的问题:
1. [问题描述]
2. [问题描述]

建议:
1. [建议内容]
2. [建议内容]
```

## 🎯 快速测试流程

1. **启动检查**
   ```bash
   tsx scripts/check-startup-conditions.ts
   ```

2. **启动服务器**
   ```bash
   npm run dev
   ```

3. **访问网站**
   - 打开 http://localhost:5173

4. **测试登录**
   - 使用测试账号登录
   - 或使用验证码登录

5. **测试核心功能**
   - 创建对话
   - 发送消息
   - 查看历史

6. **测试管理员功能**（如果有管理员账号）
   - 访问 /admin 页面
   - 测试订单管理
   - 测试激活码管理

## 💡 提示

- 开发环境下，验证码会在服务器控制台输出
- 使用 `npm run check` 进行 TypeScript 类型检查
- 定期清理过期的验证码：`tsx scripts/cleanup-verification-codes.js`
- 检查数据库迁移状态：查看 `drizzle` 目录

## 📚 相关文档

- [配置指南](./配置指南.md)
- [常见问题](./常见问题.md)
- [快速开始](../README.md)
